<!DOCTYPE html>
<html lang="en">

<!-- Head Section -->
	<head>
	    <!-- Required meta tags -->
	    <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	    <title>Training Log</title>

	    <style type="text/css">
	    	#input_block{
	    		display: none;
	    	}
	    </style>

	    <!-- Bokeh Link -->
	    <link rel="stylesheet" href="https://cdn.pydata.org/bokeh/release/bokeh-2.2.0.min.css" type="text/css" />
    	<link rel="stylesheet" href="https://cdn.pydata.org/bokeh/release/bokeh-widgets-2.2.0.min.css" type="text/css" />
    	<link rel="stylesheet" href="https://cdn.pydata.org/bokeh/release/bokeh-tables-2.2.0.min.css" type="text/css">

    	<!-- Bokeh CDN -->
		<script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-2.2.0.min.js"></script>
    	<script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-api-2.2.0.min.js"></script>
    	<script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-widgets-2.2.0.min.js"></script>
    	<script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-tables-2.2.0.min.js"></script>

    	{{ script | safe }}

	</head>

<!-- Body Section -->
	<body>
		<div id="top_block">
			<h1>Hello Training</h1>

			<p>Welcome To Training Log Application</p>
			<p>push the under button to input your training log.</p>
		</div>
		<div>
			<input type="button" value="To Input Menu" id="button_to_input_page">
			<input type="button" value="To Chart Menu" id="button_to_chart_page">
		</div>

		<div>
			<h3>Hello Bokeh</h3>
			<div id="test1"></div>
			<div id="test2"></div>
		</div>

		<div id="input_block">
			<p>Input Your Log of Training</p>

			<p>
				<label>date: </label>
				<input type="text" name="date" id="input_date">
			</p>
			<p>
				<label>milage: </label>
				<input type="text" name="date" id="input_milage">
			</p>
			<p>
				<label>elevation: </label>
				<input type="text" name="date" id="input_elevation">
			</p>
			<p>
				<label>weather_id: </label>
				<input type="text" name="date" id="input_weather_id">
				<select id="select_weather"></select>
			</p>
			<p>
				<label>target_id: </label>
				<input type="text" name="date" id="input_target_id">
			</p>
			<p>
				<input type="button" value="INPUT" id="button_input_to_db">
			</p>
			<br/>
			<p>
				<input type="button" value="BACK" id="button_back_to_top">
			</p>
		</div>

		<!-- jQuery CDN-->
		<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

		<script type="text/javascript">
			$(function(){
				console.log('jquery Start');
				//読み込みが完了した時点でメモリにselect要素を入れる処理
				let options = [['Select Weather Condition', 0],
							    ['晴れ', 71],
								['曇り', 81],
								['雨', 91],
								['晴れ/追い風', 1],
								['晴れ/向い風', 11],
								['曇り/追い風', 21],
								['曇り/向い風', 31],
								['雨/追い風', 41], 
								['雨/向い風', 51],
								['不明', 61]];
				for(let i=0; i<options.length; i++){
					$('#select_weather').append('<option value="' + options[i][1] + '">' + options[i][0] + '</option>');
				}

				//logデータを入力するブロックを表示する処理
				$('#button_to_input_page').click(function(){
					console.log('input_block fadeIn');
					$('#input_block').fadeIn();
				});

				//Top画面に戻る処理
				$('#button_back_to_top').click(function(){
					console.log('input_block fadeOut');
					$('#input_block').fadeOut();
				})

				let weather_id;
				$('#select_weather').change(function(){
					weather_id = $('option:selected').val();
					console.log('weather_id: ' + weather_id);
					console.log('weather_id type: ' + (typeof weather_id));
				})
				// let weather_id = $('#input_weather_id').val();

				//logデータをDBへ送信する処理
				$('#button_input_to_db').click(function(){
					let table = 'milage_log';
					let date = $('#input_date').val();
					let milage = $('#input_milage').val();
					if(milage != Number){
						milage = Number(milage);
					}
					let elevation = $('#input_elevation').val();
					if(elevation != Number){
						elevation = Number(elevation);
					}

					if(weather_id != Number){
						weather_id = Number(weather_id);
						console.log('weather_id: ' + (typeof weather_id));
					}
					let target_id = $('#input_target_id').val();
					if(target_id != Number){
						target_id = Number(target_id);
					}

					let data = {
						"table": table,
						"date": date,
						"milage": milage,
						"elevation": elevation,
						"weather_id": weather_id,
						"target_id": target_id
					}
					console.log('data: ' + data);

					//Ajax通信
					$.ajax({
						type: 'POST',
	                    contentType: 'application/json',
	                    url: 'https://training-logs.herokuapp.com/insert_data', 
	                    data: JSON.stringify(data),
	                    dataType: 'json'
					}).then(function(response){
						console.log('Ajax response: ' + response);
						}, function(error){
							console.log('Ajax error: ' + error);
						});
				})

				//チャートを表示する処理
				$('#button_to_chart_page').click(function(){
					let table = 'milage_log';
					let target_id = 51;
					let target_distance = 2000;
					let data = {
						'table': table,
						'target_id': target_id,
						'target_distance': target_distance
					}
					console.log('chart button clicked');
					//Ajax
					$.ajax({
						type: 'POST',
						contentType: 'application/json',
						url: 'https://training-logs.herokuapp.com/select_data',
						data: JSON.stringify(data),
						dataType: 'json'
					}).then(function(response){
						let response_data = JSON.parse(response);
						console.log('r.script: ' + response_data.script);
						console.log('r.div: ' + response_data.div);
						$('#test1').html(response_data.script);
						$('#test2').html(response_data.div);
					})
				})
			});
		</script>
	</body>
</html>
