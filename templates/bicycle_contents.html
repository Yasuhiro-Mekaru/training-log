<!DOCTYPE html>
<html lang="en">

<!-- Head Section -->
	<head>
	    <!-- Required meta tags -->
	    <meta charset="utf-8">
	    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	    <title>Training Log</title>

	    <style type="text/css">
	    	#input_block{
	    		display: none;
	    	}
	    	#test_dialog {
	    		width: 90%;
	    		height: 50%;
	    	}
	    </style>

	    <!-- Bokeh Link -->
	    <link rel="stylesheet" href="https://cdn.pydata.org/bokeh/release/bokeh-2.2.0.min.css" type="text/css" />
    	<link rel="stylesheet" href="https://cdn.pydata.org/bokeh/release/bokeh-widgets-2.2.0.min.css" type="text/css" />
    	<link rel="stylesheet" href="https://cdn.pydata.org/bokeh/release/bokeh-tables-2.2.0.min.css" type="text/css">

    	<!-- Bokeh CDN -->
		<!-- <script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-2.2.0.min.js"></script>
    	<script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-api-2.2.0.min.js"></script>
    	<script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-widgets-2.2.0.min.js"></script>
    	<script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-tables-2.2.0.min.js"></script>

    	{{ script | safe }} -->

	</head>

<!-- Body Section -->
	<body>
		<div id="top_block">
			<h1>Hello Training</h1>

			<p>Welcome To Training Log Application</p>
			<p>push the under button to input your training log.</p>
		</div>
		<div>
			<input type="button" value="Input Dialog" id="button_to_input_dialog">
			<input type="button" value="Chart Dialog" id="button_to_chart_dialog">
		</div>

		<!-- ログを入力するダイアログ -->
		<div>
			<dialog id="input_dialog">
				<h3>Input Your Logs of Training</h3>
				<br/>
				<p>
					<label>date: </label>
					<input type="text" name="date" id="input_date">
				</p>
				<p>
					<label>milage: </label>
					<input type="text" name="date" id="input_milage">
				</p>
				<p>
					<label>elevation: </label>
					<input type="text" name="date" id="input_elevation">
				</p>
				<p>
					<label>weather_id: </label>
					<select id="select_weather"></select>
				</p>
				<p>
					<label>target_id: </label>
					<input type="text" name="date" id="input_target_id">
				</p>
				<br/>
				<p>
					<input type="button" value="INPUT" id="button_input_to_db">
				</p>
				<br/>
				<input type="button" value="Back" class="button_back">
			</dialog>
		</div>

		<!-- チャートを表示するダイアログ -->
		<div>
			<dialog id="chart_dialog">
				<h3>Choose the period</h3>
				<br/>
				<p>Choose an period you want to watch chart in below selecter. </p>
				<br/>
				<select id="select_period"></select>
				<br/>
				<input type="button" value="To Chart Menu" id="button_to_chart_page">
				<br/>
				<input type="button" value="Back" class="button_back">
			</dialog>
		</div>

		<div>
			<!-- <input type="button" value="To Input Menu" id="button_to_input_page"> -->
			<!-- <input type="button" value="To Chart Menu" id="button_to_chart_page"> -->
		</div>

		<div>
			<h3>Hello Bokeh</h3>
			<div id="test1"></div>
			<div id="test2"></div>
		</div>


		<!-- jQuery CDN-->
		<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

		<script type="text/javascript">
			$(function(){
				console.log('bicycle_contents: jquery Start');

				let id;
				let distance;
		
				//読み込みが完了した時点でメモリにselect要素を入れる処理
				let options = [['Select Weather Condition', 0],
							    ['晴れ', 71],
								['曇り', 81],
								['雨', 91],
								['晴れ/追い風', 1],
								['晴れ/向い風', 11],
								['曇り/追い風', 21],
								['曇り/向い風', 31],
								['雨/追い風', 41], 
								['雨/向い風', 51],
								['不明', 61]];
				for(let i=0; i<options.length; i++){
					$('#select_weather').append('<option value="' + options[i][1] + '">' + options[i][0] + '</option>');
				}

				let weather_id;
				$('#select_weather').change(function(){
					// weather_id = $('option:selected').val();
					weather_id = $('#select_weather').val();
					console.log('weather_id: ' + weather_id);
					console.log('weather_id type: ' + (typeof weather_id));
				})
				

				//logデータをDBへ送信する処理
				$('#button_input_to_db').click(function(){
					let table = 'milage_log';
					let date = $('#input_date').val();
					let milage = $('#input_milage').val();
					if(milage != Number){
						milage = Number(milage);
					}
					let elevation = $('#input_elevation').val();
					if(elevation != Number){
						elevation = Number(elevation);
					}

					if(weather_id != Number){
						weather_id = Number(weather_id);
						console.log('weather_id: ' + (typeof weather_id));
					}
					let target_id = $('#input_target_id').val();
					if(target_id != Number){
						target_id = Number(target_id);
					}

					let data = {
						"table": table,
						"date": date,
						"milage": milage,
						"elevation": elevation,
						"weather_id": weather_id,
						"target_id": target_id
					}
					console.log('data: ' + data);

					//Ajax通信
					$.ajax({
						type: 'POST',
	                    contentType: 'application/json',
	                    url: 'https://training-logs.herokuapp.com/insert_data', 
	                    data: JSON.stringify(data),
	                    dataType: 'json'
					}).then(function(response){
						console.log('Ajax response: ' + response);
						}, function(error){
							console.log('Ajax error: ' + error);
						});
				})


				//チャートを表示する処理
				$('#button_to_chart_page').click(function(){
					let table = 'milage_log';
					let target_id = 51;
					let target_distance = 2000;
					let data = {
						'table': table,
						'target_id': target_id,
						'target_distance': target_distance
					}
					console.log('chart button clicked');
					//Ajax
					$.ajax({
						type: 'POST',
						contentType: 'application/json',
						url: 'https://training-logs.herokuapp.com/select_data',
						data: JSON.stringify(data),
						dataType: 'json'
					}).then(function(response){
						let response_data = JSON.parse(response);
						console.log('r.script: ' + response_data.script);
						console.log('r.div: ' + response_data.div);
						$('#test1').html(response_data.script);
						$('#test2').html(response_data.div);
						})
				})

				//ログインページを表示する処理
				// $('#button_to_login').click(function(){
				// 	window.location.href = 'https://training-logs.herokuapp.com/login'
				// })


				// Input Dialog ボタンを押下した際の処理
				// モーダルダイアログを表示する前にサーバーから当日の日付を取得する
				// サーバーにボタンのidを渡してサーバー側でボタンの判定ができるようにする
				// サーバーから取得した値はインプットタグに格納する
				$('#button_to_input_dialog').click(function(){
					console.log('button_to_input_dialog clicked');
					let data = {
						'button_id': 'button_to_input_dialog',
						'table': 'target_distance'
					};
					$.ajax({
						type: 'POST',
						contentType: 'application/json',
						url: 'https://training-logs.herokuapp.com/get_data',
						data: JSON.stringify(data),
						dataType: 'json'
					}).then(function(response){
						console.log('get_data response: ' + response);
						console.log('get_data response type: ' + (typeof response));
						let today = response['today'];
						let target_id = response['target_id'];
						console.log('get_data today: ' + today);
						console.log('get_data target_id' + target_id);

						$('#input_dialog').fadeIn('slow');
						$('#input_date').val(today);
						$('#input_target_id').val(target_id);
					},function(error){
						console.log('get_data error: ' + error);
					});	
				});


				// Chart Dialog ボタンを押下した際の処理
				// モーダルダイアログを表示する前にサーバーから登録月データを取得する
				// サーバーにボタンのidを渡してサーバー側でボタンの判定ができるようにする
				// サーバーから取得した値はインプットタグに格納する
				$('#button_to_chart_dialog').click(function(){
					console.log('button_to_chart_dialog clicked');
					let data = {
						'button_id': 'button_to_chart_dialog',
						'table': 'target_distance' 
					};
					$.ajax({
						type: 'POST',
						contentType: 'application/json',
						url: 'https://training-logs.herokuapp.com/get_data',
						data: JSON.stringify(data),
						dataType: 'json'
					}).then(function(response){
						console.log('get_data response: ' + response);
						console.log('get_data response type: ' + (typeof response));
						console.log('get_data response[0]: ' + response[0]);
						console.log('get_data response[0] type: ' + (typeof response[0]));
						console.log('get_data response[0][0]: ' + response[0][0]);
						console.log('get_data response[0][0] type: ' + (typeof response[0][0]));
						console.log('get_data response[0][2]: ' + response[0][2]);
						console.log('get_data response[0][2] type: ' + (typeof response[0][2]));

						for(let i=0; i<response.length; i++){
							$('#select_period').append('<option value="' + response[i][0] + '">' + response[i][1] + '</option>');
						}

						//Chart Dialog 内のセレクトボックスの値を取得する処理
						//gloal変数 id に取得した値を格納する
						$('#select_period').change(function(){
							// id = $('option:selected').val();
							id = $('#select_period').val();
							console.log('id: ' + id);

							for(let i=0; i<response.length; i++){
								if(id == response[i][0]){
									distance = response[i][2];
									if(distance != Number){
										distance = Number(distance);
									}
								}
							}
							console.log('distance: ' + distance);
							console.log('distance type: ' + (typeof distance));

							if(id != Number){
								id = Number(id);
							}
							console.log('id: ' + id);
							console.log('id type: ' + (typeof id));

							$('#button_to_chart_page').prop('disabled', false);
						})

					})

					$('#chart_dialog').fadeIn('slow');
					$('#button_to_chart_page').prop('disabled', true);
				})

				// //Chart Dialog 内のセレクトボックスの値を取得する処理
				// //gloal変数 id に取得した値を格納する
				// $('#select_period').change(function(){
				// 	// id = $('option:selected').val();
				// 	id = $('#select_period').val();
				// 	console.log('id: ' + id);
				// 	if(id != Number){
				// 		id = Number(id);
				// 	}
				// 	console.log('id: ' + id);
				// 	console.log('id type: ' + (typeof id));
				// })


				// dialogのBackボタン押下の際の処理
				// どのdialogが表示されているかを判定し条件分岐
				$('.button_back').click(function(){
					if($('#input_dialog').css('display')=='block'){
						console.log('button_back: input_dialog');
						$('#input_dialog').fadeOut('slow');
					}
					else if($('#chart_dialog').css('display')=='block'){
						console.log('button_back: chart_dialog');
						$('#chart_dialog').fadeOut('slow');
					}
				})
			});
		</script>

		<!-- Bokeh CDN -->
		<script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-2.2.0.min.js"></script>
    	<script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-api-2.2.0.min.js"></script>
    	<script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-widgets-2.2.0.min.js"></script>
    	<script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-tables-2.2.0.min.js"></script>

    	{{ script | safe }}

	</body>
</html>
